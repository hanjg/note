[toc]
## 简介 ##
- 传统分布式事务遵循ACID，牺牲系统可用性追求获取**强一致**。

### 原子性（Atomicity） ###
- 事务是一个不可分割的工作单位，这组操作要么全部发生，否则全部不发生。
- 出错时中止事务，并丢弃完成的写入。
- 也叫**可中止**性。

### 一致性（Consistency） ###
- 在事务开始以前，被操作的数据的完整性处于一致性的状态，事务结束后，被操作的数据的完整性也必须处于一致性状态。
- 拿银行转账来说，一致性要求事务的执行不应改变A、B 两个账户的金额总和。如果没有这种一致性要求，转账过程中就会发生钱无中生有，或者不翼而飞的现象。事务应该把数据库从一个一致性状态转换到另外一个一致性状态。
- **应用层**的一致性。应用层借助数据库的原子性和隔离性，达到一致性。

### 隔离性（Isolation） ###
- 事务隔离性要求系统必须保证事务不受其他并发执行的事务的影响，也即要达到这样一种效果：对于任何一对事务T1 和 T2，在事务 T1 看来，T2 要么在 T1 开始之前已经结束，要么在 T1 完成之后才开始执行。这样，每个事务都感觉不到系统中有其他事务在并发地执行。
- 事务提交时和串行执行结果一样。

### 持久性（Durability） ###
- 一个事务一旦成功提交，它对数据库的改变必须是永久的，即便是数据库发生故障也应该不回对其产生任何影响。

## 两阶段提交协议 ##
- 一个协调者（事务管理器），多个参与者（资源管理器）。
- 原子性保证——两条不归路：
  - 准备阶段参与者响应
  - 执行阶段协调者发布决策<br>![200115.two.png](https://img-blog.csdnimg.cn/20200115192344504.png)

### 准备阶段 ###
1. 协调者询问是否可以提交。
2. 参与者锁住资源，开始事务操作，写undo和redo，不提交。
3. 参与者响应，如果执行成功，返回就绪，如果失败，返回未准备。

### 执行阶段 ###
- 所有参与者就绪时，进行提交。
- 有一个参与者未准备或超时，回滚。

#### 提交 ####
1. 协调者发出正式提交请求。
2. 参与者提交本地事务，释放资源。
3. 参与者响应提交完成。
4. 协调者收到所有参与者的完成后，完成事务。

#### 回滚 ####
1. 协调者发出回滚请求。
2. 参与者用undo回滚事务，释放资源。
3. 参与者响应回滚完成。
4. 协调者收到所有参与者回滚后，取消事务。

### 优化 ###
- **最末参与者优化**（LPO，Last Participant Optimization）。最后一个参与者准备阶段和执行阶段合并成一个阶段。

### 问题 ###
1. **同步阻塞**。执行过程中，锁住资源，吞吐量低。
2. **单点问题**。第二阶段协调者故障，参与者事务一直阻塞。
3. **数据不一致**。第二阶段协调者发出提交，但是部分参与者未执行或者执行失败。
4. **二阶段固有问题**：协调者发出commit后宕机，而且唯一收到的参与者也宕机，即使新选举出协调者事务的提交状态也是不确定的。

## 标准事务模型 ##
> 两阶段提交的标准化
- X/Open事务模型，是基于**两阶段**协议的标准系统参考模型。如Innodb实现。
- TX接口：应用向协调者（事务管理器）发起、提交、回滚事务。
- XA接口：事务管理器将参与者（资源管理器）加入事务，控制两阶段提交。<br>![200114.xopen.png](https://img-blog.csdnimg.cn/20200114001719852.png)

## 三阶段提交协议 ##
- 相对两阶段的优化点：
  - **超时机制**。协调者等待参与者响应超时->协调者和参与者等待对方超时。
  - **准备阶段一分为二**。增加不锁资源的校验阶段。

### CanCommit ###
1. 协调者同步发送CanCommit请求。
2. 参与者预估状态，可以执行事务返回Yes，不可以返回No，不锁定资源。

### PreCommit ###
- 所有参与者返回Yes，进入准备阶段。
- 有一个参与者返回No或者超时，中断事务。

#### 准备 ####
1. 协调者发出PreCommit请求。
2. 参与者锁住资源，开始事务操作，写undo和redo，不提交。
3. 参与者响应，如果执行成功，返回就绪，如果失败，返回未准备。

#### 中断 ####
1. 协调者发出Abort请求。
2. 参与者收到后中断事务，或者等待PreCommit超时后中断事务。

### DoCommit ###
- 所有参与者就绪时，进行提交。
- 有一个参与者未准备或超时，回滚。

#### 提交 ####
1. 协调者发出正式提交请求。
2. 参与者提交本地事务，释放资源。
3. 参与者响应提交完成。(**如果等待doCommit请求超时，也进行提交**）
4. 协调者收到所有参与者的完成后，完成事务。

#### 回滚 ####
1. 协调者发出回滚请求。
2. 参与者用undo回滚事务，释放资源。
3. 参与者响应回滚完成。
4. 协调者收到所有参与者回滚后，取消事务。

### 解决两阶段问题 ###
1. **同步阻塞**缓解。canCommit阶段不锁资源。
2. **单点**解决。提交阶段协调者故障，参与者默认提交。
3. **数据不一致**仍然存在。doCommit阶段协调者发出回滚，部分参与者由于网络超时未收到，执行commit，出现不一致。解决需要Paxos算法。
4. **二阶段固有问题**解决：协调者发出commit后宕机，而且唯一收到的参与者也宕机,事务默认提交。

## 参考 ##
- [关于分布式事务、两阶段提交协议、三阶提交协议](https://cloud.tencent.com/developer/article/1334942)
- [常用的分布式事务解决方案](https://juejin.im/post/5aa3c7736fb9a028bb189bca#heading-11)
- [深入理解分布式系统的2PC和3PC](https://mp.weixin.qq.com/s?__biz=MzI3NzE0NjcwMg==&mid=2650120422&idx=1&sn=a63d65e3dbc0e2e252522ddfe327808f&scene=21#wechat_redirect)