[toc]
# 简介 #
- 链路层信道的类型
    1. **点对点链路**（point-to-point link）：长距离链路连接的两台路由器之间、主机与邻接的以太网交换机之间。
    2. **广播链路**（broadcast link）：以太网、无线局域网等。
- 与网络层的关系。数据报在两台路由器之间可以通过**多段链路**，多种链路，使用多种链路层协议。
- 提供的服务
    1. **成帧**。分装网络层数据报，有不同的帧格式。
    2. **链路接入**。**媒体访问控制**（Medium Access Control, MAC）协议**协调**结点发送帧，包括点对点链路和广播链路。
    3. **差错检测和纠正**。
- 链路层主体部分在**网络适配器**（network adapter）中实现，也有部分功能在主机CPU中的软件实现。

# 差错检测方法 #
1. 奇偶校验、二维奇偶校验。
2. 校验和。
3. **循环冗余检测**（Cyclic Redundancy Check, CRC）。 
    - 附加比特R共r比特，**生成多项式**G共r+1比特，数据段D共d比特。若得到的d+r比特用 **模二算数** （加减等价于**异或运算**）恰好能被G**整除**，则正确接收，否则错误。<br>![CRC.png](https://i.imgur.com/ZFmcdmH.png)
    - 附加比特R的获得方式如下，使用**模二算数**，G通常取32位。<br>![R_CRC.png](https://i.imgur.com/6bOKEv5.png)

# 多路访问协议 #
- **多路访问问题**（multiple access problem）：协调多个发送和接收结点对**共享信道**的访问。
- 多路访问协议分为三种类型：**信道划分协议**（channel partitioning protocol），**随机接入协议**（random access protocol），**轮流协议**（taking-turns protocol）。
- 理想特性：
    1. 只有一个活跃结点时，该结点具有R吞吐量。
    2. 有M个活跃结点时，每个活跃结点接近R/M的吞吐量。

## 信道划分协议 ##
1. 时分多路复用（TDM）。将时间划分为N个时间帧。
    - 消除碰撞，非常公平。
    - 结点被限制于R/N的平均速率。
    - 结点必须等待，及时只有一个结点需要发送帧。
2. 频分多路复用（FDM）。将信道划分为N个不同频段，每个频段R/N带宽。
    - 类似FDM。
3. **码分多址**（Code Division Multiple Access, CDMA），为每个结点分配不同的**编码**。 
    - 使得不同结点能够同时传输，而不相互干扰。
    - 与无线信道紧密相关。

## 随机接入协议 ##
- 一个传输结点总是以信道的**全部速率**发送。
- 当有碰撞时，涉及碰撞的结点**反复重发**帧。
- 重发之前等待一个**随机时延**。

### ALOHA ###
- 检测到碰撞之后结点以**概率p**在后序的每个时隙（时序ALOHA）或者帧传输时间（纯ALOHA)重传帧。
- 时序ALOHA效率为1/e，37%；纯ALOHA为1/2e。
- 结点的传输决定**独立**于其他结点的活动。

### CSMA ###
- **载波监听多路访问**（Carrier Sense Multiple Access, **CSMA**）<br>**具有碰撞检测的CSMA**（CSMA with Collision Detection, **CSMA/CD**）
- 适配器操作：
    1. 从网络层收到数据报，成帧，放入适配器缓存。
    2. 适配器**侦听**信道，若信道**空闲**（无信号能量从广播信道进入适配器），传输帧；否则，等待直到侦听到信道空闲。
    3. 传输过程中**监视**信道。如果传输整个帧未**碰撞**（检测到来自其他适配器的信号能量）,完成传输；否则，**中止**传输，**等待**一个随机时间量，返回2，开始侦听。
- 碰撞之后等待的时间量可用**二进制指数后退**算法，用于以太网和DOCSIS中。
    - 从{0,1...2^n-1}（n为经历的碰撞次数）中随机选择一个整数K，对于以太网，等待K*512比特时间。
    - 碰撞的结点数多，间隔时间多。
    - 一个帧经历的碰撞多，间隔时间的选择范围越大。
- 效率。prop：信道能量在任意两个适配器之间传播的最大时间；trans：传输一个最大长度的以太网帧的时间。<br>![csma.png](https://i.imgur.com/EnVZgld.png)
    - 信道能量传播时间越短，效率越高。
    - 帧传输时间约长，效率越高。

## 轮流协议 ##
1. **轮询协议**（polling protocol）。**主结点**以轮询的方式控制每个结点传输帧。
2. **令牌传递协议**（token-passing protocol）。将一个小的**令牌**（特殊帧）在结点之间以某种顺序传播，获得令牌之后发送最大数目的帧数。

# 交换局域网 #
## MAC地址 ##
- 链路层地址也称**MAC地址**、LAN地址、物理地址。不是主机和路由器具有的，是他们的**适配器**具有的。
- 链路层交换机**不具有**与他们接口相关联的链路层地址，**透明**传输。
- MAC地址长度为**6个字节**，以太网广播地址为48个连续的1。
- MAC地址具有**扁平结构**，与IP地址的**层次结构相反**，和适配器绑定，不会变化。

## ARP ##
- **地址解析协议**（Address Resolution Protocol, ARP），将IP地址映射到MAC地址。
- ARP只为**同一个子网**的主机和路由器接口解析IP地址。DNS为因特网**任何位置**的主机解析主机名。
- 每台**主机或者路由器内存**中都有一个**ARP表**。该表通过**广播**ARP查询分组和接收单播响应分组建立。<br>![arp.png](https://i.imgur.com/qP3LjZ8.png)
- 主机向子网之外主机发送数据报，目的IP地址为子网之外的主机，目的MAC地址为**第一跳路由器接口**的MAC地址。路由器接收到数据报后，查询路由器**转发表**，决定要被转发的端口，之后数据报被封装为**新的帧**从该端口发出。

## 以太网 ##
- 以太网向网络层提供不可靠传输。
### 发展 ###
1. **总线**拓扑，是一种广播局域网，使用总线连接所有适配器，使用**CSMA/CD**协议。
2. **星形**拓扑，使用**集线器**（hub）连接适配器，收到**比特**之后增强信号并向其他所有接口传输。检测到碰撞之后重传。
3. 星形拓扑，使用**交换机**（switch）。交换机是**存储转发**分组的交换机，“无碰撞”。**无须使用MAC协议**。

### 帧结构 ###
- ![ethernet](https://i.imgur.com/ha5PfYc.png)<br>是以太网**特征**。
- **地址**：适配器收到的目的地址为广播地址或者适配器MAC地址，则传递给网络层，否则丢弃。
- **数据**：以太网数据字段长度[46,1500]字节，1500字节为最大传输单元MTU。
- **类型**：使用的**网络层**协议。
- **CRC**：检测。
- **前同步码**：同步比特测传输速率，因为适配器不会精确的以额定速率传输帧，会有**漂移**。8个字节10交替，除了最后一个比特为1。

## 链路层交换机 ##
### 转发和过滤 ###
- **过滤**（filtering）：决定一个帧应该被转发到某个接口还是丢弃。<br>**转发**（forwarding）：决定一个帧应该被导向哪个接口，并将帧移动到那个接口的接口缓存。
- 过滤和转发通过**交换机表**完成。表包括MAC地址、通向该MAC地址的交换机接口、表项放置在表中的时间。<br>![switchTable.png](https://i.imgur.com/8PmSnAA.png)
- 某个目的MAC地址的帧由接口x到达。
    1. 表中没有该MAC地址表项。向除了x接口的所有接口**广播**该帧。
    2. 该MAC地址与接口x联系。无需转发，**丢弃**该帧。
    3. 该MAC地址与接口y联系。将帧放入接口y的**输出缓存**。
- 交换机通过接收的帧，将MAC地址和接口关联，并和当前时间记入交换机表，在**老化期**之后，删除该表项。
- 交换机是一种**即插即用设备**（plug-and-play device），是双工的，接口可以同时发送和接收。

### 性质 ###
1. **消除碰撞**。交换机**缓存**帧，并且**不同时**在网段上传输超过一个帧。
2. **异质链路**。**隔离**链路，不同链路可以使用不同速率。
3. **管理**。断开异常链路、统计流量等。

### 交换机和路由器 ###
- 交换机**即插即用**，路由器需要人为配置IP。
- 交换机分组过滤转发**速率**快，因为交换机处理至第二层帧，路由器处理至第三层数据报。
- 交换机活跃拓扑为**一颗生成树**，路由器没有限制。
- 交换机对**广播风暴**不提供保护，路由器提供防火墙保护。

## 虚拟局域网 ##
- **虚拟局域网**（Virtual Local Network, VLAN），可以隔离流量、有效使用交换机（充分利用端口）、方便用户迁移。
- 基于**端口**的VLAN中，端口被划为为多个组，每个组构成一个VLAN。
- VLAN帧在初始以太网的帧上增加4个字节的**VLAN标签**。<br>![vlan.png](https://i.imgur.com/vbgQqJu.png)
    - 2个字节**标签协议字符**。
    - 2个字节**标签控制信息字符**。**12比特的VLAN标识字段**、3比特优先权字段。
- 两个隔离的VLAN之间需要通过**路由器**或者**三层交换机**相连。
- 同一个VLAN位于两台交换机，需要通过**VLAN干线连接**（VLAN trunking），该干线端口属于所有VLAN。

# 数据中心网络 #
- **数据中心网络**（data center network），将内部的主机彼此互联并与因特网连接。用于支持云应用。<br>![dcn.png](https://i.imgur.com/daYahhb.png)
    - 外部请求首先被定向到**负载均衡器**，然后向主机发放请求。这样可以平衡主机的**负载**，还可以隐藏网络**内部结构**。
    - **等级结构**可以解决扩展性问题，但是主机到主机之间的**容量受限**。
- 发展趋势
    1. **全连接拓扑**（fully connected topology），不同层次的交换机之间有多条路径，减轻主机之间的容量限制。
    2. **模块化数据中心**（Modular Data Center, MDC），主机装配在**集装箱**中部署，一旦故障或者性能下降到某一值，使用新的集装箱代替。