[toc]
# 简介 #
- 无线网络的要素
    1. **无线主机**（wireless host）。端系统。
    2. **无线链路**（wireless communication link）。主机连接基站或另一台主机。
    3. **基站**（base station）。主机和基站**关联**：主机位于基站的无线通信覆盖范围，且主机使用基站中继和更大的网络的数据。例如，蜂窝网中的 **蜂窝塔**（cell tower），Wifi中的**接入点**（access point）。
    4. **网络基础设施**。与主机通信的更大的网络。<br>![wireless.png](https://i.imgur.com/RgjjskO.png)
- 与基站关联的主机以**基础设施模式**（infrastructure mode）运行，传统网络服务（地址分配、路由选择）通过基站提供给主机。<br>**自组织网络**（ad hoc network）中，主机不与基站相连，主机本身提供这些服务。
- 无线网络类型。标准：无线网分组跨越的无线跳、是否有基础设施。
    1. 单跳、基于基础设施。802.11、3G蜂窝网等。
    2. 单跳、无基础设施。蓝牙、自组织模式的802.11
    3. 多跳、基于基础设施。结点通过无线结点中继通信，连接到基站，如无线网状网络。
    4. 多跳、无基础设施。移动自组织网络，包括车载自组织网络。

# 无线链路 #
- 无线网络比特差错率较高，不仅需要CRC，还可能需要链路层ARQ重传受损的帧。
- 两台主机不足以相互检测到对方的传输，由于
    - 由于物理阻挡存在**隐藏终端问题**（hidden terminal problem）。
    - 信号**衰减**（fading）。

## 无线网络特征 ##
- **信号强度递减**。有路径耗损。
- **其他源的干扰**。如2.4GHz的802.11b受到对应无线电话和环境电子噪音影响。
- **多径传播**。由于地面发射通过多条路径传播，接收的信号**模糊**。

## 物理层特征 ##
- 对于给定的调制方案，**SNR**（信噪比，Signal-to-Noise Ratio）越高，**BER**（比特差错率）越低。
- 对于给定的SNR，较高比特传输速率的调制技术具有较高的BER。
- 物理层可以根据信道条件**动态**选择调制技术。

## CDMA ##
- **码多分址**（Code Divison Multiple Access, CDMA），是一种**信道划分协议** 。每个要发送的比特乘一个信号比特编码，这个信号变化速率（**码片速率**, chipping rate）比初始数据快。接收方再乘以相同的编码获得原始数据。<br>例如，发送方使用的CDMA码：(1,1,1,-1,1,-1,-1,-1)发送01比特，0表示为-1：<br>![cdma.png](https://i.imgur.com/SKkilat.png)
- 注意点
    1. CDMA**编码**选择。通常需要正交。
    2. 不同发送方的**信号强度**可能不同。

# 两种无线网络 #
## WiFi ##
- **IEEE 802.11 无线LAN**，也称**WiFi**，是一种较小范围的**接入网**技术。


### 体系结构 ###
- 802.11基本构建模块为**基本服务集**（Basic Service Set, BSS），一个BSS包括多个无线站点和一个**接入点**（Access Point, AP, 中央**基站**）。802.11站点可以自己组合成一个自组织网络。<br>![bss.png](https://i.imgur.com/UXButeW.png)
- 802.11频段2.4~2.4835GHz，分为11个部分重叠的信道，其中只有3个非重叠信道，在同一个物理网络中可以连接3个AP，然后连接到一个交换机上。
- 无线站点**关联**AP
    1. **被动扫描**。扫描信道，监听**信标帧**（beacon frame）。
    2. **主动扫描**。向主机范围内的所有AP**广播探测帧**，AP用**探测响应帧**应答。
    3. 之后无线主机向AP发送**关联请求帧**，AP以**关联响应帧**响应。

### MAC协议 ###
- **带碰撞避免的CSMA**（CSMA with collision avoidance, **CSMA/CA**）。<br>链路层确认/重传（ARQ）。
- 未实现碰撞检测而用碰撞避免的原因：
    1. 802.11适配器上，**接收信号强度**通常远小于发送信号的长度，检测碰撞代价大。
    2. 适配器会由于**隐藏终端和衰减**无法检测到所有碰撞。
- 目的站点收到一个通过CRC的帧后，等待一个**短帧间间隔**（Short Inter-Frame Spacing, SIFS），发回**确认帧**。如果给定时间内未收到确认帧，重传该帧，若干次重传未确认，则放弃重传丢弃该帧。
- 发送帧的步骤：
    1. 站点监听到信道空闲，等待一个**分布式帧间间隔**（Distributed Inter-Frame Space, DIFS）后发送帧，等确认。
    2. 否则，站点选取一个**随机回退值**（二进制指数回退），并在侦听到信道空闲之后递减该值，信道忙时该值不变。当计数为0时，发送帧，等确认。
    3. 收到确认后若有帧要发送，继续第一步。若未收到确认，进入第二步的回退阶段。<br>![csmaca_arq.png](https://i.imgur.com/1uQskUn.png)
- 即使信道空闲，CSMA/CA也使用倒计数抑制传输。
    - 因为回退不同的值，**发送有先后**，后发送的站点接收到先发送的站点的信号，会暂停计数，从而避免碰撞。
    - 如果两个站点相互**隐藏**，或者**随机回退值非常接近**，仍然可能碰撞。
- 处理终端隐藏
    - 发送方使用**请求发送**（Request to Send, RTS）控制帧，AP**允许发送**（Clear to Send, CTS）控制帧 **预约**对信道的访问。
    - 当帧长超过**门限值**时使用两个控制帧，减少消耗的信道资源。

### 帧格式 ###
- ![80211.png](https://i.imgur.com/Aj6JhMr.png)
- 有效载荷。通常小于1500字节。
- 地址。处于**互联**需要3个地址，地址4在**自组织**模式中使用。
    1. 地址2。**发送**该帧的站点MAC地址。
    2. 地址1。**接收**该帧的站点的MAC地址。
    3. 地址3。BSS是一个子网或者一部分，需要与路由器接口相连，地址3位**路由器接口**的MAC地址。
- 序号。**区分**新传输的帧和重传的帧。 
- 持续期。**预约信道**的时间，包括传输数据帧和传输确认的时间。
- 控制字段。
    - 类型、子类型用于区分关联、RTS、CTS、ACK、数据帧。
    - 到AP和从AP，定义不同地址的含义，随着发送者、使用模式变化。
    - WEP。是否加密。

#### 帧地址的变化 ####
- ![80211frame.png](https://i.imgur.com/UFPZ7Xg.png)
- R1到H1
    - 路由器R1将数据报封装在以太网帧中，源地址为R1的MAC地址，目的地址为H1的MAC地址。
    - 帧到AP后，由802.3以太网帧转换为802.11无线网帧。地址1为接收方H1的MAC地址，地址2为发送方AP的MAC地址，地址3为R1的MAC地址。
- H1到R1
    - H1生成一个802.11帧，地址1为AP的MAC地址，地址2为H1的MAC地址，地址3为R1的MAC地址。
    - AP收到该帧后，转为以太网帧，源地址为H1的MAC地址，目的地址为R1的MAC地址。
- 地址3允许**AP构建以太网帧时**确定目的MAC地址，在BSS和有线局域网**互联**中起作用。

### 其他性质 ###
- **速率适应**。条件较好（收到ACK），增加传输速率，条件变差（没有收到ACK），减小传输速率。类似TCP拥塞机制。
- **功率管理**。一个结点可以明显的在睡眠和唤醒状态之间交替。
    - 结点向AP指示打算睡眠，并设置定时器，在AP发送信标帧（100ms一次）前**唤醒**（约250us）结点。
    - 结点睡眠时，AP先**缓存**帧，待以后传输。
    - 短暂的唤醒时间、接收信标帧时间、检查缓存帧的时间，能大大节约能源。

## 蜂窝网 ##
- WiFi热区范围较小，蜂窝网通过**基站控制器**（Base Station Controller, BSC）和**收发基站**（Base Transceiver Station, BTS）组成**GSM基站系统**，并将它们连接，可以进行大范围的无线覆盖。一个基站覆盖的区域类似**蜂窝**。
- 蜂窝电话进行扩展，不光可以传播语音，还可以传输IP数据报。

# 移动管理 #
## 原理 ##
- **归属网络**（home network）：一个移动结点的永久居所。
- **归属代理**（home agent）：归属网络中代表移动结点执行移动管理功能的实体。
- **外部网络**（foreign network）：移动结点当前所处网络，也称为**被访网络**（visited network）。
- **外部代理**（foreing agent）：外部网络中代表结点移动管理的实体。
- **通信者**（correspondent）：希望与移动结点通信的实体。<br>![mobile.png](https://i.imgur.com/uO3Xyvr.png)

### 寻址 ###
- 外部代理为移动节点创建**转交地址**（Care-Of Address, **COA**），与外部网络匹配。一个移动结点可以和两个地址相关联，**永久地址**（permanent address）和COA。
- 外部代理可以告诉归属代理，该移动结点在他的外部网络和他的**COA**。

### 间接路由选择 ###
- 步骤：
    1. 数据报导向移动结点的**归属网络**。
    2. 归属代理将原始数据报**封装**（encapsulate）成大数据报，交付到移动结点的COA。
    3. 拥有该COA的外部代理接收并**拆封**大数据报，向移动结点转发原始数据报。
    4. 移动结点使用**永久地址为源地址**，通信者地址为目的地址，直接发送数据报到通信者。<br>![indirect.png](https://i.imgur.com/K01CkZb.png)
- 用户移动到新的网络时，注册新的COA，更新原本归属代理中的COA。
- 存在**三角路由选择问题**，即使通信者和移动结点之间有更有效的路径，也会**先发给归属代理**，再发到外部网络。

### 直接路由选择 ###
- 步骤：
    1. **通信者代理**向归属代理查询移动结点的COA。
    2. 通信者代理使用**隧道技术**经过外部代理发往移动结点。
- 移动结点移动到另一个外部网络时
    1. 移动结点向新的外部代理注册。
    2. 新的外部代理向**锚外部代理**（首次发现移动结点时对应的外部代理）提供移动结点新的**COA**。
    3. 锚外部代理收到发往该移动结点的数据报后，使用新的COA重新**封装**数据报，并且发向移动结点。
    4. 如果移动结点又移动到新的外部网络，对应的外部代理需要随后建立和锚代理的联系。<br>![direct.png](https://i.imgur.com/Zluy19I.png)

## 移动IP ##
1. **代理发现**。代理通告服务或者移动结点请求服务。
    - **代理通告**。外部代理和归属代理周期性的**广播**类型9的ICMP报文，包括**COA**等信息。
    - **代理请求**。移动结点**广播**类型10的ICMP报文，收到请求的代理**单播**一个代理通告。
2. **向归属代理注册**。移动结点收到COA后，该地址必须向归属代理注册。
    1. 收到外部代理通告之后，**移动结点**向外部代理发送**注册报文**，放入端口号434的UDP数据报中，包括：通告的COA、归属代理地址（HA）、移动结点永久地址（MA）、请求注册寿命、注册标识。
    2. **外部代理**收到注册后记录**永久IP**（封装的数据报的目的地址为该永久IP，则该数据包需要解封）。向归属代理发送注册报文。
    3. **归属代理**接收后验证，将移动结点的**永久IP和COA绑定**（到达永久IP的数据报被封装，隧道方式经外部代理发给COA）。归属代理发送注册回答。
    4. **外部代理**接收注册回答，转发个移动结点。
3. **数据报的间接路由选择**。

# 对高层的影响 #
- TCP并不知道报文段被丢弃的原因，拥塞、切换外部网络、检测到比特差错。发送方会重传报文，减小拥塞窗口。解决方法：
    1. **本地恢复**。使用链路层ARQ。
    2. 发送方知晓**无线链路**。区分出拥塞丢包，仅对该情况拥塞控制。
    3. **分离连接方法**。有线部分使用标准TCP，无线部分使用运输层选择性重传协议。