[toc]
## mysql简介 ##
### 架构 ###
- 连接池组件对接各种客户端，**插件式**基于**表**的存储引擎管理底层文件。<br>![190805.mysql.png](https://img-blog.csdnimg.cn/20190805101435768.png)

### 连接方式 ###
- TCP/IP，最多。
- 命名管道、共享内存、UNIX域套接字。需在一台服务器。

### 特点 ###
- 优点：
  - 关系型数据库，支持复杂条件查询。
  - 性能较高。
  - 成熟的多活、主从、sharding方案。
- 缺点：
  - 大量数据需要分库分表。需要中间件，拆库迁移数据较麻烦。

### 主要存储引擎 ###
- Innodb。支持事务，面向在线事务处理（OLTP），行锁设计，支持外键，默认读取不产生锁。
- MyISAM。不支持事务，支持全文索引，面向在线分析（OLAP）。

## Innodb架构 ##
- ![190805.innodb.png](https://img-blog.csdnimg.cn/20190805102907958.png)

### 后台线程 ###
- Master Thread： 异步刷新缓冲池数据到磁盘，保持数据一致性。包括脏页刷新、合并插入缓冲、UNDO页回收。
- IO Thread： 处理AIO请求的回调。
- Purge Thread： 事务提交后，回收已使用完的Undo页。
- Page Cleaner Thread: 刷新脏页。

### 内存池 ###
- ![190805.memory.png](https://img-blog.csdnimg.cn/20190805103941405.png)
- **缓冲池**：
  - 读取时先读缓冲池，没有则从磁盘读取之后FIX在缓冲池。
  - 修改时修改缓冲池中的页，在checkpoint时刷新到磁盘。
  - 改进LRU算法管理缓冲池，新读到的页放到LRU列表的 **midpoint** 。防止扫描操作用非热点数据将热点数据从LRU列表中移除。
- **重做日志缓冲**， 在以下三种情况下刷新到磁盘重做日志：
  - Master线程每秒刷新。
  - 事务提交时刷新。
  - 重做日志缓冲池剩余空间小于一半。
- **额外内存池**，存一些缓冲控制对象，空间不够会从缓冲池中申请。

## 提交流程 ##
### WAL ###
- **Write Ahead Log**策略：
  1. 事务提交前先写**redo日志**和**undo日志**。
  2. 再修改**缓冲池中的页**。
  3. checkpoint时**刷新脏页到磁盘**（两次写）,并修改checkpoint位置。
  4. 如果宕机丢数据可由checkpoint之后的redo日志恢复，符合持久性要求，减少恢复时间。

> checkpoint和redo日志通过LSN（Log Sequence Number）标识版本号，即时序。<br>
> checkpoint之后redo日志对应的脏页均未刷新到磁盘。

### checkpoint分类 ###
- Sharp checkpoint： 数据库关闭时刷新所有脏页到磁盘。
- Fuzzy checkpoint： 刷新一部分脏页到磁盘。
  - Master Thraed CheckPoint： Mater线程刷新缓冲池中的脏页到磁盘。
  - FLUSH_LRU_LIST CheckPoint： **LRU列表可用空闲页数量不足**，从列表尾部移除页，如果是脏页，则checkpoint。
  - Async/Sync Flush CheckPoint： **重做日志不可用**时，刷新脏页到磁盘，循环利用重做日志。
  - Dirty Page Too much CheckPoint： **脏页数量太多** ，保证缓冲池中有足够可用页。

## 关键特性 ##
### 插入缓冲 ###
- 使用条件：  
  - 插入**非聚集索引**。
  - 索引**非唯一**（非Unique）。

> 插入聚集索引一般是主键增长，顺序的，不需要随机的磁盘读写。

- 使用流程：
  - 插入时，如果索引页在缓冲池中，直接插入。
  - 不在缓冲池，插入Insert Buffer对象（共享表空间的B+树），定期合并插入缓冲和辅助索引的叶节点。类似Hbase的 **LSM树** 。
- 合并时机：
  - 辅助索引页被读到缓冲池，如select。
  - 追踪辅助索引页的Insert Buffer Bitmap监测到辅助索引页可用空间不够。
  - Master线程刷新多个索引页。
- 缺点：
  - 大量写时宕机，导致缓冲池数据未合并，从redo恢复时间较长。
  - 大量写时占用过多的缓冲池内存，最多1/2。

### 两次写 ###
- 原因：
  - 部分写失效：将缓冲池中的页写到表中，进行到一半数据库宕机，磁盘数据页的数据损坏。<br>
  - redo日志只记录对表的操作，重做需要页的原始副本，对已经损坏的页没有意义。
- 流程：
  - 刷脏页时，先写内存中的doublewrite buffer。
  - 通过buffer先后写到共享表空间（**顺序写**，开销小）脏页副本和磁盘（随机写）。
  - 实例恢复时，通过页的共享表空间副本还原原始数据页，再重做。<br> ![190816.double.png](https://img-blog.csdnimg.cn/20190816125700861.png)

### 自适应hash索引 ###
- 从缓冲池的B+树页构建，存在缓冲池自适应哈希索引区，是对**页**的索引，不是整张表的。
- 条件：
  - 连续访问模式（查询条件）一致。
  - 次数超过页中记录/16。

### 异步IO ###
- 或者叫并发IO，索引扫描、刷新脏页等。

### 刷新临近页 ###
- 刷新脏页时，如果同区有脏页，一起刷新。
- 机械硬盘推荐使用。

## 存储 ##
- 逻辑存储结构。**表空间**（tablespace），**段**（segment），**区**（extent,1MB），**页/段**（page/block，默认16KB），行。